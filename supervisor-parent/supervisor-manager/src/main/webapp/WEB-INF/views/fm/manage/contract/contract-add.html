<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!-- InstanceBegin template="/Templates/menu-list.dwt" codeOutsideHTMLIsLocked="false" -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- InstanceBeginEditable name="doctitle" -->
<title>私享家电子商贸平台</title>
<link href="${b.staticPath}style/style.css" rel="stylesheet"
	type="text/css" />
<link rel="stylesheet" href="${b.staticPath}js/datepicker.css" />
<script src="${b.staticPath}js/jquery.js"></script>
<script src="${b.staticPath}js/datepicker.js"></script>
<script src="${b.staticPath}js/datepicker.zh-CN.js"></script>
<link rel="stylesheet" type="text/css" href="${b.staticPath}style/elastislide.css" />
<script src="${b.staticPath}js/intense.js"></script>
<script src="${b.staticPath}js/jqueryui.js"></script>
<link href="${b.staticPath}style/jquery.iviewer.css" rel="stylesheet" type="text/css" />
<script src="${b.staticPath}js/jquery.iviewer.js" type="text/javascript"></script>
<script src="${b.staticPath}js/jquery.bigautocomplete.js"></script>
<script src="${b.staticPath}js/jquery.paginate.js"></script>
<script type="text/javascript" src="${b.staticPath}js/jquery.mousewheel.js" ></script>
<script src="${b.staticPath}js/jquery.elastislide-style.js" type="text/javascript" ></script>
<script src="${b.staticPath}js/jquery.elastislide.js" type="text/javascript"></script>
<@b.validate/>
<style type="text/css">
.checkinfo{
	border:1px solid #ccc; 
	padding:2px 20px 2px 5px; 
	color:#666; 
	position:absolute;
	display:none;
	line-height:20px;
	background-color:#fff;
}
</style>
<script>
var ul_validform;
	jQuery(document).ready(function($) {
		$('.demo-image').click(function() {
			$('.maskdivgen').fadeIn(100);
			$('.viewer').slideDown(200);
		})
		$('.modal-header .close').click(function() {
			$('.maskdivgen').fadeOut(100);
			$('.viewer').slideUp(200);
		})
	})
	$(document).ready(function() {
		var imgPath = $("#imgId").val();
		$.ajaxSetup ({     
		    cache: false 
		}); 
		$.post("${basePath}filesort.htm",{fileId:imgPath},function(imgPaths){
			var j =0;
			for (var i = 0; i < imgPaths.length; i++) {
				j=i+1;
				$("#carousel").append('<li><a href="javascript:void(0);" class="demo-image" data-image="${b.imagePath}'+imgPaths[i]+'"><img src="${b.imagePath}'+imgPaths[i]+'80x100.JPG" alt="" /></a><p>'+j+'</p></li>');
			}
			
			$( '.elastislide-list' ).elastislide({
				orientation : 'horizontal',
				speed : 500,
				easing : 'ease-in-out',
				minItems : 3,
				start : 0,
				onClick : function( el, position, evt ) { 
					var imageSource = el.find("a").attr("data-image");
					$("#viewer2").iviewer({
						src : imageSource,
						mousewheel : true
					});
					el.parent().children("li").removeClass("view");
					el.addClass("view");
					$("#viewer2").children("img").attr("src",imageSource);
					$(".viewer").show();
					$(".modal-header").show();
					$(".maskdivgen").show();
					return false; 
				},
				onReady : function() { return false; },
				onBeforeSlide : function() { return false; },
				onAfterSlide : function() { return false; }
			});
			
		});
	}); 
</script>
<!-- InstanceEndEditable -->
<!-- InstanceBeginEditable name="head" -->
<!-- InstanceEndEditable -->
<script>
	var num = 1;
	function addTable() {
		var vTb = $("#TbData");//得到表格ID=TbData的jquery对象 
		var totalTr = $("#total_tr");
		//所有的数据行有一个.CaseRow的Class,得到数据行的大小 
		var vNum = $("#TbData tr").filter(".CaseRow").size() + 1;//表格有多少个数据行 
		var vTr = $("#TbData #trDataRow1"); //得到表格中的第一行数据 
		var vTrClone = vTr.clone(true);//创建第一行的副本对象vTrClone 
		var id = "trDataRow" + vNum;
		vTrClone[0].id = id;//設置 第一個Id為當前獲取索引；防止重複添加多個ID為trDataRow1的數據行；一次添加一個；
		//alert(vTrClone.find("td :last").find('a').text());	
		vTrClone.find("td :last").attr("onclick", "");
		vTrClone.find("td :last").addClass("TrDel");
		vTrClone.find("td :last").html("x");//更改按钮
		//清空内容
		vTrClone.find("td").eq(0).find("input").val("");
		vTrClone.find("td").eq(1).find("input").val("");
		vTrClone.find("td").eq(2).find("input").val("");
		vTrClone.find("td").eq(3).find("input").val("");
		vTrClone.find("td").eq(4).find("input").val("");
		vTrClone.find("td").eq(5).find("input").val("");
		//设置item[]

		vTrClone.find("td").eq(0).find("input").attr("name",
				"items[" + num + "].productName");
		vTrClone.find("td").eq(1).find("input").attr("name",
				"items[" + num + "].productModel");
		vTrClone.find("td").eq(2).find("input").attr("name",
				"items[" + num + "].quantity");
		vTrClone.find("td").eq(3).find("input").attr("name",
				"items[" + num + "].price");
		vTrClone.find("td").eq(4).find("input").attr("name",
				"items[" + num + "].amount");
		vTrClone.find("td").eq(5).find("textarea").attr("name",
				"items[" + num + "].remarks");
		num++;

		vTrClone.insertBefore(totalTr);//把副本单元格对象添加到表格上方 
	}

	$(function() {
		$(".TrDel").live("click", function() {
			$(this).parent().parent().remove();
		});
	});
	function saveContract() {
		if (!ul_validform.check()){
			return false;
		}
			var size=$("#TbData tr").filter(".CaseRow").size();
			for (var i=0;i<size;i++){
				var num1=$("#TbData tr").filter(".CaseRow").eq(i).find("td").eq(4).find("input").val();
				$("#TbData tr").filter(".CaseRow").eq(i).find("td").eq(4).find("input").val(parseFloat(num1)*100);
				var num2=$("#TbData tr").filter(".CaseRow").eq(i).find("td").eq(3).find("input").val();
				$("#TbData tr").filter(".CaseRow").eq(i).find("td").eq(3).find("input").val(parseFloat(num2)*100);
			}
		$.post("addContract.htm", $("#addForm").serialize(), function(data) {
			if (data.isOK == 'ok') {
				alert("生成合同成功");
				window.location.href = "${basePath}record/recordList.htm";
			} else {
				alert("生成合同失败");
			}
		});

	}
	
	$(function(){
		$(".amountClass").keyup(function(){
			var amount=0;
			var size=$("#TbData tr").filter(".CaseRow").size();
			for (var i=0;i<size;i++){
				var num=$("#TbData tr").filter(".CaseRow").eq(i).find("td").eq(4).find("input").val();
				$("#TbData tr").filter(".CaseRow").eq(i).find("td").eq(4).find("input").val(getFloatStr(num));
				if(num==''){
					amount+=parseFloat(parseFloat(0));
				}else{
					amount+=parseFloat(parseFloat(num));
				}
			}
			$("#amountSum").html(getFloatStr(amount));
		});
		$(".quantityClass").keyup(function(){
			var quantity=0;
			var size=$("#TbData tr").filter(".CaseRow").size();
			for (var i=0;i<size;i++){
				var num=$("#TbData tr").filter(".CaseRow").eq(i).find("td").eq(2).find("input").val();
				if(num==''){
					quantity+=parseFloat(0);
				}else{
					quantity+=parseFloat(num);
				}
			}
			$("#quantitySum").html(quantity);
		});
		$(".priceClass").keyup(function(){
			var size=$("#TbData tr").filter(".CaseRow").size();
			for (var i=0;i<size;i++){
				var num=$("#TbData tr").filter(".CaseRow").eq(i).find("td").eq(3).find("input").val();
				$("#TbData tr").filter(".CaseRow").eq(i).find("td").eq(3).find("input").val(getFloatStr(num));
			}
		});
		
		//初始化验证
		ul_validform=$("#contractUl").Validform({
			tiptype:function(msg,o,cssctl){
					var $div=$("<div/>").addClass("checkinfo");
					var $p=$("<p/>").addClass("Validform_checktip Validform_wrong").html(msg);
					var left=o.obj.offset().left,
					top=o.obj.offset().top;
					var width=o.obj.width();
					$div.append($p).css({
						'left':left+width-32,
						'top':top-45,
						'position':'absolute'
					}).show();
					o.obj.parent().append($div);
			}});
		$("#contractUl").find("[datatype]").each(function(){
			$(this).focus(function(){
				$(this).parent().children(".checkinfo").hide();
			}); 
			$(this).blur(function(){
				var pass=ul_validform.check(true,$(this));
				if(!pass)
					$(this).parent().children(".checkinfo").show();
			});
		});
	});
	//将传入数据转换为字符串,并清除字符串中非数字与.的字符
    //按数字格式补全字符串
    var getFloatStr = function(num){
        num += '';
        num = num.replace(/[^0-9|\.]/g, ''); //清除字符串中的非数字非.字符
        
        if(/^0+/) //清除字符串开头的0
            num = num.replace(/^0+/, '');
        if(!/\./.test(num)) //为整数字符串在末尾添加.00
            num += '.00';
        if(/^\./.test(num)) //字符以.开头时,在开头添加0
            num = '0' + num;
        num += '00';        //在字符串末尾补零
        num = num.match(/\d+\.\d{2}/)[0];
        return num;
    };
</script>
</head>
<body>
	<@b.header/>
	<div id="main" class="fence-wide">
		<!-- InstanceBeginEditable name="local" -->
		<!-- InstanceEndEditable -->
		<@b.menuPath/>
		<div id="mainBg" class="ly-clearFix yard-1200">
			<div id="leftList"><@b.leftMenu /></div>
			<form action="addContract.htm" method="post" id="addForm">
				<input type="hidden" name="recordId" value="${record.id}" />
				
				<div id="rightBar">
					<!-- InstanceBeginEditable name="rightBar" -->
					<h2 class="title">生成合同确认书</h2>
					<div class="infoBox producedBox f14" id="contractUl">
						<ul class="ly-clearFix" >
							<li><label>工程名称</label><input type="text" value="" name="contract.engName" datatype="*1-50" errormsg="输入范围在1~50位之间！" nullmsg="请输入工程名称！" /></li>
							<li><label>工程地址</label><input type="text" value=""
								name="contract.engAddress" datatype="*1-100" errormsg="输入范围在1~100位之间！" nullmsg="请输入工程地址！"/></li>
							<li><label>甲方</label><span class="jquery-live-search-example"><input type="text" readonly="readonly" value="${record.memberNameA}" id="memberNameA"
								class="batch-text" name="contract.memberNameA" /></span>
								<input type="hidden" value="${record.memberIdA}" id="memberIdA" class="batch-text" name="contract.memberIdA" />
								</li>
							<li><label>乙方</label><span class="jquery-live-search-example"><input type="text"  readonly="readonly" value="${record.memberNameB}" id="memberNameB"
								class="batch-text" name="contract.memberNameB" /></span>
								<input type="hidden" value="${record.memberIdB}" id="memberIdB" class="batch-text" name="contract.memberIdB" />
								</li>
							<li><label>签订地点</label><input type="text" value=""
								name="contract.address" datatype="*1-100" errormsg="输入范围在1~100位之间！" nullmsg="请输入签订地点！" /></li>
							<li><label>签订时间</label><input type="text" value=""
								name="contract.signedDate" datepicker datatype="*1-100" readonly="readonly" errormsg="请选择正确的日期!" nullmsg="请选择签订时间！"  /></li>
							<li><label>合同期限</label><input type="text" value=""
								name="contract.validityDate" datepicker datatype="*1-100" readonly="readonly" errormsg="请选择正确的日期!" nullmsg="请选择合同期限！" /></li>
							<li><label>生效时间</label><input type="text" value=""
								name="contract.startDate" datepicker datatype="*1-100" readonly="readonly" errormsg="请选择正确的日期!" nullmsg="请选择生效时间！" /></li>
						</ul>
						<table border="0" cellpadding="0" cellspacing="0" id="TbData"
							class="tabList producedTable">
							<col width="20%" />
							<col width="20%" />
							<col width="15%" />
							<col width="15%" />
							<col width="10%" />
							<col width="15%" />
							<col width="5%" />
							<tr>
								<th>产品名称</th>
								<th>产品规格</th>
								<th>数量<#if record.contractType.getId()==1>/㎡</#if><#if record.contractType.getId()==2>/吨</#if></th>
								<th>单价<span class="money">&yen;</span><#if record.contractType.getId()==1>/㎡</#if><#if record.contractType.getId()==2>/吨</#if>
								</th>
								<th>金额<span class="money">&yen;</span></th>
								<th>备注说明</th>
								<th class="rLine">&nbsp;</th>
							</tr>
							<tr id="trDataRow1" class="CaseRow">
								<td><input type="text" value="" name="items[0].productName" datatype="*1-50" errormsg="输入范围在1~50位之间！" nullmsg="请输入产品名称！" /></td>
								<td><input type="text" value="" name="items[0].productModel" datatype="*1-100" errormsg="输入范围在1~100位之间！" nullmsg="请输入产品规格！"/></td>
								<td><input type="text" value="" name="items[0].quantity" class="quantityClass" onkeyup="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}"
                                    onafterpaste="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'0')}else{this.value=this.value.replace(/\D/g,'')}" datatype="n1-20" errormsg="输入范围在1~20位数字之间！" nullmsg="请输入产品数量！" /></td>
								<td><input type="text" value="" name="items[0].price" class="priceClass" datatype="/^(?!0+(?:\.0+)?$)(?:[1-9]\d*|0)(?:\.\d{1,2})?$/" errormsg="输入范围在1~20位之间！" nullmsg="请输入产品单价！" /></td>
								<td><input type="text" value="" name="items[0].amount" class="amountClass" datatype="/^(?!0+(?:\.0+)?$)(?:[1-9]\d*|0)(?:\.\d{1,2})?$/" errormsg="输入范围在1~20位之间！" nullmsg="请输入产品单价！"  /></td>
								<td><textarea id="textarea" cols="45" rows="1"
										name="items[0].remarks"></textarea></td>
								<td><a href="javascript:void(0);" class="lnk-green"
									name="add" onclick="addTable()">+</a></td>
							</tr>
							<tr id="total_tr">
								<td><strong>合计</strong></td>
								<td>&nbsp;</td>
								<td><span id="quantitySum">0</span><#if record.contractType.getId()==1>/㎡</#if><#if record.contractType.getId()==2>/吨</#if></td>
								<td>&nbsp;</td>
								<td><span id="amountSum">0</span>元</td>
								<td>&nbsp;</td>
								<td>&nbsp;</td>
							</tr>
						</table>
						<div>
							<label>交货地址</label><input type="text" value=""
								name="contract.deliveryAddress" datatype="*1-100" errormsg="输入范围在1~100位之间！" nullmsg="请输入交货地址！" />
						</div>
						<div>
							<label>合同总批次</label><input type="text" value=""
								name="contract.batchCount" datatype="n1-10" errormsg="输入范围在1~10位数字之间！" nullmsg="请输入合同总批次！" />
						</div>
						<div>
							<label>合同定金</label><input type="text" value=""
								name="contract.deposit" datatype="*1-100" errormsg="输入范围在1~100位之间！" nullmsg="请输入合同定金！" /> 元
						</div>
						<div>
							<label>合同备注</label>
							<textarea id="textarea2" cols="80" rows="2"
								name="contract.remarks"></textarea>
						</div>
						<div class="contPic">
							<label>合同扫描件</label>
							<input type="hidden" value="${record.imgPath}" id="imgId" />
								<div class="rollBox">
									<ul id="carousel" class="elastislide-list"></ul>
								</div>
						</div>			
						<div>
							<label>关联招标合同号</label><input type="text" value="${record.refContractNo}"
								name="contract.refContractNo" datatype="*1-10" errormsg="输入范围在1~10位之间！"   />
						</div>
						<div class="btnBox">
							<a href="javascript:void(0);"
								class="button button-orange button-small"
								onclick="saveContract();">生成</a><a
								href="javascript:history.go(-1);"
								class="button button-gray button-small">返回</a>
						</div>
					</div></div>
			</form>
			<!-- InstanceEndEditable -->
		</div>
	</div>
	<@b.footer />
	<div class="viewer modal-wrap" style="display: none">
									<div class="modal-header">
										<span class="close">关闭</span>
									</div>
									<div id="viewer2" class="modal-body"></div>
								</div>
	<div class="maskdivgen" style="display: none"></div> 
</body>
<!-- InstanceEnd -->
</html>
