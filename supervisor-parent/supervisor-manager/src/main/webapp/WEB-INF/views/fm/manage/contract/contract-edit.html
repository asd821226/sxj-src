<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!-- InstanceBegin template="/Templates/menu-list.dwt" codeOutsideHTMLIsLocked="false" -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- InstanceBeginEditable name="doctitle" -->
<title>私享家电子商贸平台</title>
<link href="${b.staticPath}style/style.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="${b.staticPath}js/datepicker.css"/>
<script src="${b.staticPath}js/jquery.js"></script>
<script src="${b.staticPath}js/datepicker.js"></script>
<script src="${b.staticPath}js/datepicker.zh-CN.js"></script>
<script src="${b.staticPath}js/intense.js"></script>

<script src="${b.staticPath}js/jquery.bigautocomplete.js"></script>
<script src="${b.staticPath}js/jqueryui.js"></script>
<link href="${b.staticPath}style/jquery.iviewer.css" rel="stylesheet" type="text/css" />
<script src="${b.staticPath}js/jquery.iviewer.js" type="text/javascript"></script>
<script src="${b.staticPath}js/jquery.imagecontainer.js" type="text/javascript"></script>
<script src="${b.staticPath}js/jquery.paginate.js"></script>

<script type="text/javascript" src="${b.staticPath}js/jquery.mousewheel.js" ></script>
<!-- InstanceEndEditable -->
<!-- InstanceBeginEditable name="head" -->
<!-- InstanceEndEditable -->
<script>
	jQuery(document).ready(function($) {
		$('.demo-image').click(function() {
			$('.maskdivgen').fadeIn(100);
			$('.viewer').slideDown(200);
		})
		$('.modal-header .close').click(function() {
			$('.maskdivgen').fadeOut(100);
			$('.viewer').slideUp(200);
		})
	})
	window.onload = function() {
		$(".demo-image").click(function() {
			var imageSource = $(this).attr("data-image");
			$("#viewer2").iviewer({
				src : imageSource,
				mousewheel : true
			});
		});
	}
</script>
<@b.upload/>
<script>
$(document).ready(function() { 
	classLoadUpload("上传扫描件");
});  
function modify(){
	var recordNo0 = $("#recordNo0").val();
	var recordNo1 = $("#recordNo1").val();
	var contractId = $("#contractId").val();
	if(recordNo1!=''){
		$("#recordNo").val(recordNo0+","+recordNo1);
	}else{
		$("#recordNo").val(recordNo0);
	}
	var recordNo =$("#recordNo").val();
	$.post("getRecordNo.htm",{recordNo:recordNo,contractId:contractId},function(data){
		if(data.flag=='true'){
			$.post("modify.htm",$("#modifyForm").serialize(),function(data){
				if (data.isOK == 'ok') {
					  alert("修改成功")
					  window.location.href="query.htm";
					}else{
						alert("修改失败");
					}
			})
		}else{
			alert("请检查备案号是否正确!");
		}
	})
	
}

</script>
</head>
<body>
<@b.header/>
	<div id="main" class="fence-wide">
		<!-- InstanceBeginEditable name="local" -->
		<@b.menuPath/>
		<!-- InstanceEndEditable -->
		<div id="mainBg" class="ly-clearFix yard-1200">
			<div id="leftList"><@b.leftMenu /></div>
			<div id="rightBar">
			<form action="" id="modifyForm" method="post">
				<h2 class="title">修改采购合同</h2>
				<div class="infoBox producedBox f14">
				<input type="hidden" value="${contractModel.contract.id}" id="contractId"  name="contract.id" />
				<input type="hidden" value="${contractModel.contract.contractNo}" id=""  name="contract.contractNo" />
					<ul class="ly-clearFix">
						<li><label>合同号</label> ${contractModel.contract.contractNo}</li>
						<li><label>签订地点</label> <input name="contract.address" type="text"
							value="${contractModel.contract.address}" /></li>
						<li><label>甲方</label> <input name="contract.memberNameA" type="text"
							value="${contractModel.contract.memberNameA}" /></li>
						<li><label>乙方</label> <input name="contract.memberNameB" type="text"
							value="${contractModel.contract.memberNameB}" /></li>
						<li><label>工程名称</label> <input name="contract.engName" type="text"
							value="${contractModel.contract.engName}" /></li>
						<li><label>工程地址</label> <input name="contract.engAddress" type="text"
							value="${contractModel.contract.engAddress}" /></li>
						<li><label>对应备案号</label> 
						<#assign record=(contractModel.contract.recordNo?split(","))>
						<#list record as recordNo>
						<input name="" type="text" value="${recordNo}" id="recordNo${recordNo_index}" class="input-w80" />
						<#if record?size==1><input name="" type="text" value="" id="recordNo1" class="input-w80" /></#if>
						</#list>
						<input name="contract.recordNo" type="hidden" id="recordNo"
							value="${contractModel.contract.recordNo}"  />
						</li>
						<li><label>签订时间</label> <input name="contract.signedDate" type="text" value="${contractModel.contract.signedDate?string('yyyy-MM-dd')}" datepicker /> </li>
						<li><label>合同期限</label> <input name="contract.validityDate" type="text" value="${contractModel.contract.validityDate?string('yyyy-MM-dd')}" datepicker /></li>
						<li><label>生效时间</label>
							${contractModel.contract.startDate?string("yyyy-MM-dd")}</li>
					</ul>
					<table border="0" cellpadding="0" cellspacing="0"
						class="tabList producedTable">
						<col width="20%" />
						<col width="20%" />
						<col width="15%" />
						<col width="10%" />
						<col width="10%" />
						<col width="20%" />
						<col width="5%" />
						<tr>
							<th>产品名称</th>
							<th>产品规格</th>
							<th>数量<span>（<#if contractModel.contract.type.getId()==1>/㎡</#if><#if contractModel.contract.type.getId()==2>/吨</#if>）</span></th>
							<th>单价<span>(元<#if contractModel.contract.type.getId()==1>/㎡</#if><#if contractModel.contract.type.getId()==2>/吨</#if>)</span></th>
							<th>金额<span>(元)</span></th>
							<th>备注说明</th>
							<th class="rLine">&nbsp;</th>
						</tr>
						<#assign n = 0> 
						<#assign m = 0>
						 <#list contractModel.itemList as item>
						  <#assign n = (n+item.price)?int > 
						  <#assign m = (m+item.amount)?int >
						  <input name="itemList[${item_index}].id"
								type="hidden" value="${item.id}" />
						<tr>
							<td><input
								name="itemList[${item_index}].productName"
								type="text" value="${item.productName}" /></td>
							<td><input
								name="itemList[${item_index}].productModel"
								type="text" value="${item.productModel}" /></td>
							<td><input
								name="itemList[${item_index}].quantity" type="text"
								value="${item.quantity}" /></td>
							<td><input name="itemList[${item_index}].price"
								type="text" value="${item.price/100}" /></td>
							<td><input
								name="itemList[${item_index/100}].amount" type="text"
								value="${item.amount}" /></td>
							<td><textarea
									name="itemList[${item_index}].remarks" cols=""
									rows="2">${item.remarks}</textarea></td>
							<td class="color-red">！</td>
						</tr>
						</#list>
						<tr>
							<td><strong>合计</strong></td>
							<td>&nbsp;</td>
							<td>${n}</td>
							<td>&nbsp;</td>
							<td>${m}</td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
						</tr>
					</table>
					<div>
						<label>交货地址</label> <input name="contract.deliveryAddress" type="text"
							value="${contractModel.contract.deliveryAddress}" />
					</div>
					<table border="0" cellpadding="0" cellspacing="0"
						class="tabList producedTable">
						<col width="20%" />
						<col width="30%" />
						<col width="20%" />
						<col width="10%" />
						<col width="20%" />
						<tr>
							<th>交货批次</th>
							<th>产品规格</th>
							<th>数量<span>（<#if contractModel.contract.type.getId()==1>/㎡</#if><#if contractModel.contract.type.getId()==2>/吨</#if>）</span></th>
							<th>应付货款<span>（元）</span></th>
							<th class="rLine">对应批次RFID编号</th>
						</tr>
						<#list modifyList.modifyBatchList  as modifyBatch>
						<input name="batchList[${modifyBatch_index}].id" type="hidden" value="${modifyBatch.modifyBatch.id}" />
						<tr>
							<td>第 <input name="batchList[${modifyBatch_index}].batchNo" type="text" value="${modifyBatch.modifyBatch.batchNo}" class="input-w30" />
								批次
							</td>
							<td><table border="0" cellpadding="0" cellspacing="0"
									class="tabList prodIable">
									 <#list modifyBatch.modifyBatchItems  as modifyBatchItems>
									<tr>
										<td><input name="batchList[${modifyBatch_index}].batchItems[${modifyBatchItems_index}].productModel" type="text"
											value="${modifyBatchItems.productModel}" />
										<input name="batchList[${modifyBatch_index}].batchItems[${modifyBatchItems_index}].id" type="text"
											value="${modifyBatchItems.id}" />	
										</td>
									</tr>
									</#list>
								</table></td>
							<td><table border="0" cellpadding="0" cellspacing="0"
									class="tabList prodIable">
									  <#list modifyBatch.modifyBatchItems  as modifyBatchItems>
									<tr>
										<td><input name="batchList[${modifyBatch_index}].batchItems[${modifyBatchItems_index}].quantity" type="text" value="${modifyBatchItems.quantity}" /> &nbsp;</td>
									</tr>
									 </#list>
								</table></td>
							<td><input name="batchList[${modifyBatch_index}].amount" type="text" value="${modifyBatch.modifyBatch.amount/100}" /></td>
							<td><input name="batchList[${modifyBatch_index}].rfidNo" type="text" value="${modifyBatch.modifyBatch.rfidNo}" /></td>
						</tr>
              </#list>
					</table>
					<div>
						<label>本合同还有</label> <input name="contract.batchCount" type="<#if contractModel.batchList?exists> ${(contractModel.contract.batchCount-contractModel.batchList?size)?int}
            <#else> ${contractModel.contract.batchCount} </#if>" value="2" class="input-w30" /> 批次待交付
					</div>
					<div>
						<label>合同定金</label> <input name="contract.deposit" type="text" value=" ${contractModel.contract.deposit}" />
						元
					</div>
					<div>
						<label>合同备注</label>
						<textarea name="contract.remarks" id="textarea2" cols="80" rows="3">${contractModel.contract.remarks}</textarea>
					</div>
						<div class="contPic">
							<label>合同备案扫描件</label>
							<div class="rollBox">
								<div class="LeftBotton" onmousedown="ISL_GoUp()"
									onmouseup="ISL_StopUp()" onmouseout="ISL_StopUp()"></div>
								<div class="Cont" id="ISL_Cont">
									<div class="ScrCont">
										<div id="List1">
											<!-- 图片列表 begin -->
											<#assign arr=(contractModel.contract.imgPath?split(","))>
											<#list arr as imgPath>
											<div class="pic">
												<a href="#" class="demo-image"
													data-image="${b.imagePath}${imgPath}"><img
													src="${b.imagePath}${imgPath}" /></a>
											</div>
											</#list>
											<!-- 图片列表 end -->
										</div>
										<div id="List2"></div>
									</div>
								</div>
								<div class="RightBotton" onmousedown="ISL_GoDown()"
									onmouseup="ISL_StopDown()" onmouseout="ISL_StopDown()"></div>
							</div>
						</div>
						<div class="contPic">
						<label>合同备案扫描件</label>
						<div class="ly-left">
						<div class="imageList">
						</div>
						<input type="hidden" name="contract.imgPath" class="imgPathHide" id="contractImgPathHide" value=""/>
						<input type="file" name="contractFile" id="contractFile"  multiple="true"/></div>
					</div>
					<div>
						<label>关联招标合同号</label> <input name="contract.refContractNo" type="text"
							value="${contractModel.contract.refContractNo}" />
					</div>
				</div>
				<#if contractModel.modifyList?exists>
				<div class="changeBox">
					<h2 class="title">合同变更信息</h2>
					<#list contractModel.modifyList as modifyList>
					<input type="hidden" value="${modifyList.modifyContract.id}" name="modifyList[${modifyList_index}].modifyContract.id" />
					<div class="infoBox producedBox f14">
						<div>
							<label>合同变更备案号</label> ${modifyList.modifyContract.recordNo}
						</div>
						<script>
							$(document).ready(function() { 
								loadUpload("modifyFile","upload.htm","modifyimageList","modifyContractHide${modifyList_index}");
							});  
						</script>
						<div class="contPic">
							<label>合同变更扫描件</label>
					<div class="ly-left">
						<div class="imageList">
						</div>
						<input type="hidden" name="modifyList[${modifyList_index}].modifyContract.imgPath" class="imgPathHide" value=""/>
						<input type="file" name="contractFile" id="contractFile"  multiple="true"/></div>
					</div>
    					<div></div>
						<table border="0" cellpadding="0" cellspacing="0"
							class="tabList producedTable">
							<col width="20%" />
							<col width="20%" />
							<col width="15%" />
							<col width="10%" />
							<col width="10%" />
							<col width="25%" />
							<tr>
								<th>产品名称</th>
								<th>产品规格</th>
								<th>数量<span>（<#if contractModel.contract.type.getId()==1>/㎡</#if><#if contractModel.contract.type.getId()==2>/吨</#if>）</span></th>
								<th>单价<span>(元<#if contractModel.contract.type.getId()==1>/㎡</#if><#if contractModel.contract.type.getId()==2>/吨</#if>)</span></th>
								<th>金额<span>(元)</span></th>
								<th class="rLine">备注说明</th>
							</tr>
             			<#list modifyList.modifyItemList  as modifyItem>
             			
							<tr>
								<td><input type="text" value="${modifyItem.productName}" name="modifyList[${modifyList_index}].modifyItemList[${modifyItem_index}].productName" /></td>
								<td><textarea name="modifyList[${modifyList_index}].modifyItemList[${modifyItem_index}]" id="textarea9" cols="25"
										rows="1">${modifyItem.productModel}</textarea></td>
								<td><input type="text" value="${modifyItem.quantity}" name="modifyList[${modifyList_index}].modifyItemList[${modifyItem_index}].quantity" /></td>
								<td><input type="text" value="${modifyItem.price/100}" name="modifyList[${modifyList_index}].modifyItemList[${modifyItem_index}].price" /></td>
								<td><input type="text" value="${modifyItem.amount/100}" name="modifyList[${modifyList_index}].modifyItemList[${modifyItem_index}].amount" /></td>
								<td><textarea name="modifyList[${modifyList_index}].modifyItemList[${modifyItem_index}].remarks" id="textarea10" cols="25"
										rows="1">${modifyItem.remarks}</textarea> 
										&nbsp;&nbsp;<a href="#" class="lnk-green">X</a><input type="hidden" name="modifyList[${modifyList_index}].modifyItemList[${modifyItem_index}].id" value="${modifyItem.id}" /> </td>
							</tr>
						 </#list>
						</table>
						<table border="0" cellpadding="0" cellspacing="0"
							class="tabList producedTable">
							<col width="20%" />
							<col width="25%" />
							<col width="20%" />
							<col width="10%" />
							<col width="25%" />
							<tr>
								<th>交货批次</th>
								<th>产品规格</th>
								<th>数量<span>（<#if contractModel.contract.type.getId()==1>/㎡</#if><#if contractModel.contract.type.getId()==2>/吨</#if>）</span></th>
								<th>应付货款<span>（元）</span></th>
								<th class="rLine">对应批次RFID编号</th>
							</tr>
							<#list modifyList.modifyBatchList  as modifyBatch>
							<input type="hidden" name="modifyList[${modifyList_index}].modifyBatchList[${modifyBatch_index}].modifyBatch.id" value="${modifyBatch.id}" /> 
							<tr>
								<td>第${modifyBatch.modifyBatch.batchNo}批次</td>
								<td><table border="0" cellpadding="0" cellspacing="0"
										class="tabList prodIable">
                  					<#list modifyBatch.modifyBatchItems  as modifyBatchItems>
										<tr>
											<td><textarea name="modifyList[${modifyList_index}].modifyBatchList[${modifyBatch_index}].modifyBatchItems[${modifyBatchItems_index}].productModel" id="textarea15"
													cols="25" rows="1">${modifyBatchItems.productModel}</textarea>
											<input type="hidden" name="modifyList[${modifyList_index}].modifyBatchList[${modifyBatch_index}].modifyBatchItems[${modifyBatchItems_index}].id" value="${modifyBatchItems.id}" /> 
													
											</td>
										</tr>
									 </#list>
									</table></td>
								<td><table border="0" cellpadding="0" cellspacing="0"
										class="tabList prodIable">
										<#list modifyBatch.modifyBatchItems  as modifyBatchItems>
										<tr>
											<td><input type="text" value="${modifyBatchItems.quantity}" name="modifyList[${modifyList_index}].modifyBatchList[${modifyBatch_index}].modifyBatchItems[${modifyBatchItems_index}].quantity" /> &nbsp;<a
												href="#" class="lnk-green">+</a></td>
										</tr>
										 </#list>
									</table></td>
								<td><input type="text" value="${modifyBatch.modifyBatch.amount/100}" name="modifyList[${modifyList_index}].modifyBatchList[${modifyBatch_index}].modifyBatch.amount" /></td>
								<td><input type="text" class="input-w80" value="${modifyBatch.modifyBatch.rfidNo}" name="modifyList[${modifyList_index}].modifyBatchList[${modifyBatch_index}].modifyBatch.rfidNo" />
									<a href="#" class="lnk-green">X</a></td>
							</tr>
							</#list>
						</table>
					</div>
					</#list>
				</div>
				</#if>
				 <#if contractModel.replenishList?exists>
				<div class="changeBox">
					<h2 class="title">合同补损信息</h2>
					<#list contractModel.replenishList as replenishList>
					<input type="hidden" value="${replenishList.replenishContract.id}" name="replenishList[${replenishList_index}].replenishContract.id" />
					<div class="infoBox producedBox f14">
						<div>
							<label>合同补损备案号</label> ${replenishList.replenishContract.recordNo}
						</div>
						<div>
							<label>补损批次RFID</label> ${replenishList.replenishContract.batchRfidNo}
						</div>
						<div class="contPic">
							<label>合同补损扫描件</label>
						<div class="ly-left">
						<div class="imageList">
						</div>
						<input type="hidden" name="replenishList[${replenishList_index}].replenishContract.imgPath" class="imgPathHide" value=""/>
						<input type="file" name="contractFile" id="contractFile"  multiple="true"/></div>
						</div>
						<table border="0" cellpadding="0" cellspacing="0"
							class="tabList producedTable">
							<col width="10%" />
							<col width="25%" />
							<col width="20%" />
							<col width="10%" />
							<col width="15%" />
							<col width="20%" />
							<tr>
								<th>交货批次</th>
								<th>产品规格</th>
								<th>数量<span>（<#if contractModel.contract.type.getId()==1>/㎡</#if><#if contractModel.contract.type.getId()==2>/吨</#if>）</span></th>
								<th>应付货款<span>（元）</span></th>
								<th>对应批次RFID编号</th>
								<th class="rLine">新RFID编号</th>
							</tr>
							<#list replenishList.batchItems as replenishItem>
							<tr>
								<td>第${replenishItem.replenishBatch.batchNo}批次
								<input type="hidden" value="${replenishItem.replenishBatch.id}" name="replenishList[${replenishList_index}].batchItems[${replenishItem_index}].replenishBatch.id" />
								</td>
								<td><table border="0" cellpadding="0" cellspacing="0"
										class="tabList prodIable">
										 <#list replenishItem.replenishBatchItems as replenishBatchItems>
										<tr>
											<td><textarea name="replenishList[${replenishList_index}].batchItems[${replenishItem_index}].replenishBatchItems[${replenishBatchItems_index}].productModel" id="textarea14"
													cols="25" rows="1">${replenishBatchItems.productModel}</textarea></td>
										</tr>
										</#list>
									</table></td>
								<td><table border="0" cellpadding="0" cellspacing="0"
										class="tabList prodIable">
										<#list replenishItem.replenishBatchItems as replenishBatchItems>
										<tr>
											<td><input type="text" value="${replenishBatchItems.quantity}" name="replenishList[${replenishList_index}].batchItems[${replenishItem_index}].replenishBatchItems[${replenishBatchItems_index}].quantity" />
											</td>
										</tr>
										</#list>
									</table></td>
								<td><input type="text" value="${replenishItem.replenishBatch.amount/100}" name="replenishList[${replenishList_index}].batchItems[${replenishItem_index}].replenishBatch.amount" /></td>
								<td><input type="text" class="input-w80" value="${replenishItem.replenishBatch.rfidNo}" name="replenishList[${replenishList_index}].batchItems[${replenishItem_index}].replenishBatch.rfidNo" /></td>
								<td><input type="text" class="input-w80" value="${replenishItem.replenishBatch.newRfidNo}" name="replenishList[${replenishList_index}].batchItems[${replenishItem_index}].replenishBatch.newRfidNo" />
									&nbsp;<a href="#" class="lnk-green">X</a></td>
							</tr>
							</#list>
						</table>
						<div>
							<label>RFID订单号</label><input type="text" value="${replenishList.replenishContract.rfidOrderNo}" name="replenishList[${replenishList_index}].replenishContract.rfidOrderNo" />
						</div>
					</#list>	
					</#if>
					<div class="btnBox">
							<a class="button button-orange button-small" onclick="modify();">修改</a><a
								href="javascript:history.go(-1);"
								class="button button-gray button-small">返回</a>
						</div>
					</div>
				</div>
				</form>
				<!-- InstanceEndEditable -->
			</div>
		</div>
		<@b.footer />
		<div class="viewer modal-wrap" style="display: none">
									<div class="modal-header">
										<span class="close">关闭</span>
									</div>
									<div id="viewer2" class="modal-body"></div>
								</div>
	<div class="maskdivgen" style="display: none"></div> 
</body>
<!-- InstanceEnd -->
</html>