<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>私享家绿色门窗平台</title>
<meta name="keywords" content="私享家绿色门窗平台,门窗,型材厂,玻璃厂,门窗">
<meta name="description" content="私享家绿色门窗平台,为门窗行业的玻璃厂,型材厂提供产品盘点,物流跟踪,质量溯源服务。致力于推动江苏省房地产建筑行业绿色环保事业。">
<link href="${b.staticPath}style/style.css" rel="stylesheet" type="text/css" />
<script src="${b.staticPath}js/jquery.js" type="text/javascript"></script>
<script src="${b.staticPath}js/jquery.poshytip.min.js"></script>
<@b.validate/>
<@b.pageScript/>
<@b.errorInfo/>
<Script>
var editId;
jQuery(document).ready(function($) {
	$('.modal-header .close').click(function(){
		$('.maskdivgen').fadeOut(100);
		$('.passwordPop').slideUp(200);
	})
	})
 
  //增加子账户
  function add_account(id){
	$.post("new_account.htm",{id:id},function(data){
		$("#right_div").empty();
		$("#right_div").append(data);
	})
 }
  function query(page){
		var params=$("#search_form").serialize();
		 if(page!=undefined){
			   params=params+"&currentPage="+page;
		   }
		$.post("accountList.htm",params,function(data){
			var res=$(data).find("#res_table");
			var pager=$(data).find("#pager");
			$("#res_table").empty();
			$("#res_table").append(res.html());
			var totalPage=pager.attr("totalPage");
			var currentPage=pager.attr("currentPage");
			loadPage(currentPage,totalPage,query);
		});
  }
  
  function roleInfo(id,type){
		$.get("${basePath}member/account/get_role_function.htm?accountId="+id+"&type="+type,function(data){
			$("#roleInfo_div").empty();
			$("#roleInfo_div").css("display","");
			$("#roleInfo_div").append(data);
		});
	}
  function closeDiv(divId){
		$("#"+divId).css("display","none");
	}
//修改密码
  function edit_pwd(id){
	$('.maskdivgen').fadeIn(100);
	$('.passwordPop').slideDown(200);
	editId=id;
  }
  //提交修改密码
  function save_pwd(){
	  var pwd1=$("#pwd1").val();
	  var pwd2=$("#pwd2").val();
	  if (pwd1 =="" || pwd2 =="" ){
		  alert("密码不能为空！")
		  return false;
	  }
	  if (pwd1 !=pwd2){
		  alert("两次密码输入不一样，请重新输入");
		  return false;
	  }
	  $.post("save_pwd.htm",{id:editId,password:pwd1},function(data){
		  alert("修改成功！");
		  $('.maskdivgen').fadeOut(100);
		  $('.passwordPop').slideUp(200);
	  })
  }
  //修改
  function edit_account(id){
	   $("#"+id).find("#name_td").hide();
	   $("#"+id).find("#name_td2").show();
	   $("#"+id).find("#account_td").hide();
	   $("#"+id).find("#account_td2").show();
	   $("#"+id).find("#role_td").hide();
	   $("#"+id).find("#editrole_td").show();
	   $("#"+id).find("#edit_td").hide();
	   $("#"+id).find("#confim_td").show();
  }
  
  //确认修改
  var regex =/^[\u4e00-\u9fa5a-zA-Z-0-9]{2,20}$/ ;
  function edit_save(id){
	  var params=$("#"+id).find(":input");
	  var name=$("#"+id).find("#nameEdit").val();
	  var accountName=$("#"+id).find("#accountEdit").val();
	   if (!regex.test(accountName) || accountName==""){
		   alert("子帐号不能为空，或特殊字符");
		   return false;
	   }
	   if (!regex.test(name) || name==""){
		   alert("姓名不能为空，或特殊字符");
		   return false;
	   }
	  $("#edit_form").append(params.html());
	  $.post("editAccount.htm",params,function(data){
			if(data.isOK=='ok'){
				query();
				alert("修改成功");
			}else{
				errorInfo(data);
			}
		});
  }
//更改状态
  function checkState(id,stateId){
	  $.post("editState.htm",{id:id,state:stateId},function(data){
		  if (data.isOK=='ok'){
			  query();
		   }else{
				errorInfo(data);
			}
	  })
}
</Script>
</head>

<body>
<@b.header />
<div class="mainBg">
<div class="fence-wide ly-clearFix">
<div class="main pb20">
<div class="yard-190 ly-left leftMenu">
<@b.leftMenu />
</div>
<div class="yard-870 rightSide ly-left" id="right_div">
<div class="heading mb15 ly-clearFix">
  <h1 class="ly-left">
  <span class="title fontYH f20 fb">子帐号管理</span></h1>
</div>
<div class="contBox f12">
<div class="addBox mb10">
<a href="#" class="lnk-green" onclick="add_account('${account.id}')"><span class="icon icon16 icon-add"></span>新增子帐号</a>
</div>
<div class="searBox mb10">
<form id="search_form" action="javascript:void(0);">
姓名<input type="text" class="input" name="name" value="">帐号名<input type="text" class="input" name="accountName" value="">权限
          <select name="functionId">
          <option value="">-请选择-</option>
           <#list functions as f>
           <#if f.id==query.functionId>
            <option value="${f.id}" selected="selected">${f.title}</option>
            <#else>
             <option value="${f.id}">${f.title}</option>
            </#if>
            </#list>
          </select><button class="button button-search" onclick="query();">查询</button>
</form>
</div>
<form id="edit_form"></form>
<@b.pager/>
  <table border="0" cellpadding="0" cellspacing="0" class="tabList" id="res_table">
  <col width="9%" />
  <col width="12%" />
  <col width="12%" />
  <col width="15%" />
  <col width="10%" />
  <col width="15%" />
  <col width="20%" />
    <tr>
      <th>会员号</th>
      <th>姓名</th>
      <th>帐号名</th>
      <th>权限</th>
      <th>状态</th>
      <th>增加时间</th>
      <th class="rLine">&nbsp;</th>
      <#list list as account>
    </tr>
    <tr id="${account.id}">
     <input id="functionIds_hidden" type="hidden" name="functionIds" value="none" />
	 <input id="id_hidden" type="hidden" name="id" value="${account.id}" />
      <td>${account.accountNo}</td>
      <td id="name_td">${account.name}</td>
      <td id="name_td2" style="display: none"><input type="text" value="${account.name}" id="nameEdit" name="name"/></td>
      <td id="account_td">${account.accountName}</td>
      <td id="account_td2" style="display: none"><input type="text" value="${account.accountName}" id="accountEdit" name="accountName"/></td>
      <td id="role_td" ><a href="javascript:roleInfo('${account.id}','get');" class="lnk-blue">查看</a></td>
      <td id="editrole_td" class="permission" style="display: none" onclick="roleInfo('${account.id}','edit');">
      	 <div class="dropMenu sltinput" id="district_cn"> <span>全部权限</span> <span class="icon"></span>
     	 </div>
      </td>
      <#if (account.state.id == 1)>
      <td><button class="button button-red" onclick="checkState('${account.id}','${account.state.id}')" >停用</button></td>
      <#elseif (account.state.id == 0)>
      <td><button class="button button-green" onclick="checkState('${account.id}','${account.state.id}')" >恢复</button></td>
      </#if>
      <td>${account.regDate?date}</td>
      <td id="edit_td"><a href="javascript:void(0);" class="lnk-blue mr20" onclick="edit_account('${account.id}')"><span class="icon icon16 icon-edit"></span>修改</a><a href="javascript:void(0);" class="lnk-blue btnPassword" onclick="edit_pwd('${account.id}')"><span class="icon icon16 icon-password" ></span>修改密码</a></td>
      <td id="confim_td" style="display: none"><a href="javascript:void(0);"  onclick="edit_save('${account.id}')" class="lnk-green mr20"><span class="icon icon16 icon-ok"></span>确认</a><a href="javascript:void(0);" class="lnk-blue" onclick="edit_pwd('${account.id}')"><span class="icon icon16 icon-password"></span>修改密码</a></td>
    </tr>
    </#list>
  </table>
  <div id="roleInfo_div" class="modal-wrap popDemo dropList" style="display:none;">
</div>
</div>
</div>
</div>
</div>
<@b.footer />
<div class="modal-wrap popDemo contPop passwordPop" style="display:none;">
      <div class="modal-header"><span class="close">关闭</span></div>
      <div class="modal-body">
        <div class="item"><label>新密码</label><input type="password" class="input input-w180h30" id="pwd1"/></div>
        <div class="item"><label>确认密码</label><input type="password" class="input input-w180h30" id="pwd2"/></div>
      <div class="item"><label>&nbsp;</label><button class="button button-pop" onclick="save_pwd()">确认修改</button><button class="button button-gray">取消</button></div>
  </div>
</div>
    <div class="maskdivgen" style="display:none"></div>
</body>
</html>
